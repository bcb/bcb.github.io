---
layout: post
title: "Create an ECS container instance"
date: 2016-07-13 20:16:39 +1000
categories: aws
---

# IAM roles & policies

Make an `ecs-policy.json`:

{% highlight json %}
{
  "Version": "2015-07-13",
  "Statement": [
    {
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
{% endhighlight %}

Create role with policy:

{% highlight shell %}
$ aws iam create-role --role-name ecsRole --assume-role-policy-document file://ecs-policy.json
{% endhighlight %}

Make a `role-policy.json`:

{% highlight json %}
{
  "Version": "2015-07-13",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:BatchCheckLayerAvailability",
        "ecr:BatchGetImage",
        "ecr:DescribeRepositories",
        "ecr:GetAuthorizationToken",
        "ecr:GetDownloadUrlForLayer",
        "ecr:GetRepositoryPolicy",
        "ecr:ListImages",
        "ecs:CreateCluster",
        "ecs:DeregisterContainerInstance",
        "ecs:DiscoverPollEndpoint",
        "ecs:Poll",
        "ecs:RegisterContainerInstance",
        "ecs:StartTask",
        "ecs:StartTelemetrySession",
        "ecs:SubmitContainerStateChange",
        "ecs:SubmitTaskStateChange",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": [
        "*"
      ]
    }
  ]
}
{% endhighlight %}

Add role policy:

{% highlight shell %}
$ aws iam put-role-policy --role-name ecsRole --policy-name ecsRolePolicy --policy-document file://role-policy.json
{% endhighlight %}

Create instance profile with role:

{% highlight shell %}
$ aws iam create-instance-profile --instance-profile-name webserver
$ aws iam add-role-to-instance-profile --instance-profile-name webserver --role-name ecsRole
{% endhighlight %}

# Create a security group

With ports 22 and 80 open:

{% highlight shell %}
$ aws ec2 create-security-group --group-name MySecurityGroup --description "My security group"
$ aws ec2 authorize-security-group-ingress --group-name MySecurityGroup --protocol tcp --port 22 --cidr 0.0.0.0/0
$ aws ec2 authorize-security-group-ingress --group-name MySecurityGroup --protocol tcp --port 80 --cidr 0.0.0.0/0
{% endhighlight %}

# Launch an instance inside a cluster

Create a cluster:

{% highlight shell %}
$ aws ecs create-cluster --cluster-name MyCluster
{% endhighlight %}

Create a `userdata.txt`:

{% highlight shell %}
#!/bin/bash
echo 'ECS_CLUSTER=looked' >> /etc/ecs/ecs.config
echo 'set -o vi' >> /home/ec2-user/.bashrc # I like vi mode
{% endhighlight %}

Launch an instance inside the cluster:

{% highlight shell %}
$ aws ec2 run-instances --image-id ami-0bf2da68 --count 1 --instance-type t2.micro --key-name aws-beau-sydney --iam-instance-profile Name= webserver --security-group-id sg-xxxxxx --associate-public-ip-address --user-data file://userdata.txt
{% endhighlight %}

# Register and run a task

{% highlight shell %}
$ aws ecs register-task-definition --cli-input-json file://ecs-task.json
$ aws ecs run-task --cluster MyCluster --count 1 --task-definition web-app:1
{% endhighlight %}
